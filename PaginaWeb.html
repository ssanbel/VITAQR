<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VITAQR</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }

    body {
      background-color: #fff;
      color: #000;
    }

    header {
      display: flex;
      border-bottom: 2px solid #000;
    }

    .logo {
      font-size: 36px;
      font-weight: bold;
      color: #000000;
      padding: 18px 40px;
      background-color: white;
      display: flex;
      align-items: center;
      flex: 1;
    }

    nav {
      display: flex;
      gap: 20px;
      align-items: center;
      padding: 18px 20px;
      background-color: white;
    }

    nav a {
      padding: 28px 15px;
      text-decoration: none;
      color: #000;
      font-weight: bold;
      border-radius: 5px;
      transition: background-color 0.3s ease;
      font-size: 20px;
      cursor: pointer;
    }

    .center-nav {
      flex: 3;
      display: flex;
      justify-content: center;
    }

    nav a:hover {
      background-color: #384c6b;
      color: white;
    }
    
    nav a:focus:not(.social-icon),
    nav a:active:not(.social-icon),
    nav a.active:not(.social-icon) {
      background-color: #384c6b;
      color: white;
    }

    ul {
      margin-left: 20px;
      list-style-type: disc;
    }

    li {
      margin-bottom: 5px;
      font-size: 16px
    }

    .search-cart {
      background-color: #384c6b;
      padding: 35px 40px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .search-cart input {
      padding: 8px;
      border: 2px solid white;
      background-color: #384c6b;
      color: white;
      font-size: 18px;
      width: 210px;
    }

    .search-cart input::placeholder {
      color: #cccccc;
    }

    .search-cart button {
      font-size: 18px;
      background-color: white;
      color: black;
      padding: 8px 12px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
    }

    .search-cart button:hover {
      background-color: #ccc;
    }

    #usuario-btn {
      color: white;
      background: none;
      border: none;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    #usuario-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      display: none;
      z-index: 1000;
      min-width: 180px;
      padding: 10px 0;
    }

    #usuario-dropdown button {
      display: block;
      width: 100%;
      background: none;
      border: none;
      padding: 10px 20px;
      text-align: left;
      font-size: 16px;
      cursor: pointer;
      color: #333;
      transition: background-color 0.2s ease;
    }

    #usuario-dropdown button:hover {
      background-color: #f2f2f2;
    }

    .carrito-btn {
      background-color: white;
      padding: 8px 16px;
      font-size: 18px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
    }

    .carrito-btn:hover {
      background-color: #ccc;
    }

    main {
      padding: 5vw;
    }

    .registro-container {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 60px;
    }

    .left {
      flex: 1;
      max-width: 100%;
      min-width: unset;
    }

    .right {
      background-color: #384c6b;
      padding: 80px;
      border-radius: 15px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      width: 100%;
      max-width: 600px;
      margin-left: auto;
    }

    .logo-heart {
      text-align: center;
      margin-bottom: 30px;
    }

    .circle {
      border: 3px solid red;
      border-radius: 50%;
      width: 250px;
      height: 250px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: auto;
      font-weight: bold;
      color: red;
    }

    .circle img {
      max-width: 80%;
      height: auto;
      margin: 14px 0;
    }

    .description {
      color: #a00;
      font-size: 18px;
      margin: 20px auto;
      max-width: 500px;
      text-align: center;
    }

    .register-box {
      background-color: rgb(244, 31, 31);
      color: white;
      font-weight: bold;
      font-size: 24px;
      width: 100%;
      text-align: center;
      padding: 40px 0;
      margin-top: 40px;
      border-radius: 6px;
    }

    .register-box .arrow {
      margin-left: 10px;
      font-size: 28px;
      vertical-align: middle;
    }

    .right h2 {
      font-size: 28px;
      margin-bottom: 20px;
    }

    form input {
      width: 100%;
      padding: 14px;
      margin-bottom: 15px;
      font-size: 16px;
    }

    form button {
      width: 100%;
      padding: 14px;
      background-color: #62cbf4;
      color: white;
      font-size: 18px;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    form button:hover {
      background-color: #1666c1;
    }

    .product-gallery {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: space-between;
    }

    .product {
      width: 280px;
      text-align: center;
    }

    .product img {
      width: 100%;
      height: 240px;
      object-fit: cover;
      border-radius: 6px;
    }

    .product-name {
      margin-top: 10px;
      font-weight: normal;
    }

    .product-price {
      font-weight: bold;
    }

    .features {
      margin-top: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 150px;
      text-align: center;
      font-size: 14px;
      width: 100%;
    }

    .features img {
      width: 36px;
      display: block;
      margin: 0 auto 5px;
    }

    /* ───────────────────────────── QUIÉNES SOMOS ── */
    .faq-container{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
      gap:40px;
      line-height:1.55;
    }
    .faq h3{
      font-size:22px;
      margin-bottom:15px;
      color:#384c6b;
    }
    .faq p{
      margin-bottom:18px;
      text-align:justify;
    }

    /* ──────────────────────── MODALES & FORMULARIOS */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
      overflow: auto;
    }

    .modal-content {
      background-color: #fff;
      padding: 30px 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      margin: 40px auto;
      position: relative;
      box-sizing: border-box;
      max-height: 90vh;
      overflow-y: auto;
      text-align: center;
    }

    .modal-content h2 {
      margin-bottom: 20px;
    }

    .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      z-index: 10;
    }

    .input-group {
      position: relative;
      margin-bottom: 15px;
    }

    .input-group input {
      width: 100%;
      padding: 14px;
      font-size: 16px;
    }

    .input-group select {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      margin-bottom: 15px;
      border: 1px solid;
      border-radius: 4px;
      appearance: none;
      color: #646464;
      background-color: #fff;
    }

    .input-group.required select {
      position: relative;
      z-index: 1;
    }

    .input-group.required::after {
      content: "*";
      color: red;
      position: absolute;
      right: 10px;
      top: 12px;
      font-size: 20px;
      pointer-events: none;
      z-index: 2;
    }

    .requerido {
      text-align: left;
      font-weight: normal;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .requerido .asterisco {
      color: red;
    }

    .opciones-horizontales {
      display: flex;
      justify-content: space-around;
      gap: 10px;
      text-align: center;
      margin-top: 10px;
    }

    .opciones-horizontales label {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 15px;
      cursor: pointer;
    }

    .opciones-horizontales input[type="radio"] {
      margin-bottom: 6px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
    }

    .close-qr {
      position: absolute;
      top: 12px;
      right: 20px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }

    .qr-modal-content {
      position: relative;
      max-width: 400px;
    }


    /* Menú hamburguesa */
    .menu-toggle {
      display: none;
      font-size: 28px;
      background: none;
      border: none;
      color: #000;
      cursor: pointer;
    }

  .accordion-item {
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 15px;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .accordion-header {
    background-color: #f8f8f8;
    cursor: pointer;
    padding: 18px 20px;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 18px;
  }

  .accordion-content {
    max-height: 0;
    overflow: hidden;
    padding: 0 20px;
    background-color: #fff;
    transition: max-height 0.4s ease, padding 0.4s ease;
  }

  .accordion-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 15px;
  }

  .accordion-item.active .accordion-content {
    max-height: 700px;
    margin: 0 auto;
    padding: 20px 25px;
  }

  .separador{
    margin-top: 40px;
    margin-bottom: 30px;
  }

    /* PARA EL CELULAR (RESPONSIVOS) */    
  @media screen and (max-width: 768px) {
    header {
      flex-direction: column;
      align-items: stretch;
    }

    .menu-toggle {
      display: block;
    }

    nav {
      display: none;
      flex-direction: column;
      width: 100%;
      background-color: white;
      padding: 10px 0;
    }

    nav.show {
      display: flex;
    }

    nav a {
      padding: 12px;
      font-size: 18px;
      border-bottom: 1px solid #eee;
      text-align: center;
    }

    .search-cart {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 20px;
      background-color: #384c6b;
      flex-wrap: nowrap;
    }

    .search-cart input {
      flex: 1;
      font-size: 16px;
      padding: 8px;
      border: 2px solid white;
      background-color: #384c6b;
      color: white;
    }

    .search-cart button {
      padding: 8px;
      background-color: white;
      color: black;
      font-weight: bold;
      border: none;
      font-size: 18px;
    }

    .carrito-btn {
      font-size: 18px;
    }

    .product-gallery {
      justify-content: center;
    }

    .product {
      width: 90%;
      max-width: 300px;
      margin: 0 auto;
    }

    .features {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .features div {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 13px;
      text-align: center;
      width: 90px;
    }

    .features div span {
      white-space: nowrap;
    }

    .features img {
      width: 40px;
      height: 40px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
    }

    .top-right-icons {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .accordion-container {
      max-width: 100%;
    }

    #usuario-btn {
      font-size: 18px;
      color: #000;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
    }

    #usuario-dropdown {
      right: 0;
    }

    #quienes {
      padding: 0 20px;
    }

    #quienes p {
      text-align: justify;
    }
  }

  </style>
</head>

<body>
  <header>
    <div class="top-bar">
      <div class="logo">
        <span style="color:#f01414;">VITA</span><span style="color:#384c6b;">QR</span>
      </div>
      <div class="top-right-icons">
        <button class="menu-toggle" onclick="toggleMenu()">☰</button>
        <div id="user-container" style="display: none; position: relative;">
          {% set dni = session['usuario']['dni'] if session.get('usuario') else None %}
          {% if dni and dni|foto_existente %}
            <img id="usuario-btn"  
                src="{{ url_for('static', filename='fotos_perfil/' ~ dni ~ '.jpg') }}" 
                alt="Foto de perfil" 
                style="width: 34px; height: 34px; border-radius: 50%; object-fit: cover; cursor: pointer;" 
                onclick="toggleDropdown()" />
          {% else %}
            <button id="usuario-btn" onclick="toggleDropdown()">👤 Usuario</button>
          {% endif %}
          <div id="usuario-dropdown">
            <button onclick="abrirModalFoto()">🖼 Foto de perfil</button>
            <button onclick="abrirFormulario()">📄 Información</button>
            <button onclick="irAPlanes()">📋 Planes</button>
            <button onclick="generarQR()">📱 Generar QR</button>
            <button onclick="cerrarSesion()">🚪 Cerrar Sesión</button>
          </div>
        </div>
      </div>
    </div>
    

    <nav id="main-menu">
        <a class="nav-link active" data-target="registro">INICIO</a>
        <a class="nav-link" data-target="productos">NUESTROS PRODUCTOS</a>
        <a class="nav-link" data-target="preguntas">PREGUNTAS FRECUENTES</a>
        <a class="nav-link" data-target="quienes">¿QUIÉNES SOMOS?</a>
        <a href="https://www.facebook.com/share/16PZqSdhhT/?mibextid=wwXIfr" target="_blank" rel="noopener noreferrer" class="social-icon">
          <img src="https://cdn-icons-png.flaticon.com/256/124/124010.png" alt="Facebook" width="30px" height="30px"/>
        </a>
        <a href="https://www.instagram.com/vitaqr_?igsh=MTN3cHQzNGJ3Nnk1Mw%3D%3D" target="_blank" rel="noopener noreferrer" class="social-icon">
          <img src="https://img.icons8.com/?size=160&id=YtpeVQhQ8USm&format=png" alt="Instagram" width="42px" height="42px"/>
        </a>
      </nav>

    <div class="search-cart">
      <input type="text" placeholder="BUSCAR" />
      <button>🔍</button>
      <button onclick="irAlCarrito()" class="carrito-btn">🛒</button>

    <div class="user-cart-group">
    <div id="user-container" style="display: none; position: relative;">
      <button id="usuario-btn">👤 Usuario</button>
      <div id="usuario-dropdown">

        <button onclick="abrirModalFoto()">🖼 Foto de perfil</button>
        <button onclick="abrirFormulario()">📄 Información</button>
        <button onclick="irAPlanes()">📋 Planes</button>
        <button onclick="generarQR()">📱 Generar QR</button>
        <button onclick="cerrarSesion()">🚪 Cerrar Sesión</button>
      </div>
      </div>
      
    </div>
  </div>
</header>

  <main id="content">
    <!-- ─────────────────────── INICIO / REGISTRO -->
    <section id="registro">
      <div class="registro-container">
        <div class="left">
          <div class="logo-heart">
            <div class="circle">
              <p>VITAQR</p>
              <img src="{{ url_for('static', filename='img/Logo.jpg') }}" alt="QR" />
              <p>SIEMPRE CONTIGO</p>
            </div>
          </div>
          <p class="description">
            Nuestro propósito es facilitar el acceso rápido y seguro a información médica esencial en situaciones de emergencia o atención médica, mediante el uso de tecnología QR.
          </p>
          <button class="register-box" onclick="abrirModalRegistro()">
            REGÍSTRATE <span class="arrow">→</span>
          </button>
        </div>

        <div class="right">
          <h2>Iniciar Sesión</h2>
          <form id="loginForm" method="POST" action="/login">
            <input type="email" name="correo" id="email" placeholder="Correo electrónico" required />
            <input type="password" name="contrasena" id="password" placeholder="Contraseña" required />
            <button type="submit">Ingresar</button>
          </form>
        </div>
      </div>
    </section>

    <div id="modalSesion" class="modal" style="display:none;">
      <div class="modal-contenido">
        <span class="cerrar" onclick="cerrarModalSesion()">×</span>
        <h2>Acceso restringido</h2>
        <p>Debes iniciar sesión para continuar.</p>
        <button onclick="document.getElementById('modalSesion').style.display='none'">Aceptar</button>
      </div>
    </div>


    <!-- ───────────────────────── PRODUCTOS -->
    <section id="productos" style="display:none;">
      <div class="product-gallery">
        {% for p in productos %}
          <div class="product">
            <img src="{{ url_for('static', filename=p.imagen) }}" alt="{{ p.nombre }}">
            <h3><a href="detalle.html?id={{ p.id }}" style="text-decoration: none; color: black;">{{ p.nombre }}</a></h3>
            <p style="color: #e91e63; font-size: 22px;">S/. {{ "%.2f"|format(p.precio) }}</p>
          </div>
        {% endfor %}
      </div>

      <div class="features">
        <div>
          <img src="{{ url_for('static', filename='img/camion.jpg') }}" alt="Express" />
          Envío exprés
        </div>
        <div>
          <img src="https://img.icons8.com/ios-filled/50/000000/customer-support.png" alt="Soporte" />
          Servicio al cliente
        </div>
        <div>
          <img src="{{ url_for('static', filename='img/PagoSeguro.png') }}" alt="Pago seguro" />
          Pago 100% seguro
        </div>
      </div>  
    </section>

    <!-- ───────────────────────── PREGUNTAS FRECUENTES -->
    <section id="preguntas" style="display:none;">
      <h2 style="text-align:center; margin-bottom:30px;">Preguntas frecuentes</h2>
      <div class="accordion-container">
        
        <h3 style="margin-bottom:30px">SOBRE VITAQR</h3>
        <div class="accordion-item">
          <div class="accordion-header">¿Qué es VITAQR?</div>
          <div class="accordion-content">
            VITAQR es una herramienta de asistencia médica personalizada que utiliza un código QR para brindar acceso inmediato a información médica esencial en situaciones de emergencia.
          </div>
        </div>

        <div class="accordion-item">
          <div class="accordion-header">¿Cómo funciona VITAQR?</div>
          <div class="accordion-content">
            Al escanear el código QR con un teléfono inteligente, se accede a un perfil médico digital donde se muestran datos relevantes como alergias, enfermedades crónicas, grupo sanguíneo, medicamentos actuales, contactos de emergencia, etc.
          </div>
        </div>

        <div class="accordion-item">
          <div class="accordion-header">¿Qué información puedo incluir en mi perfil VITAQR?</div>
          <div class="accordion-content">
            <p>Puedes incluir:</p>
            <ul>
              <li>Nombre completo</li>
              <li>Alergias</li>
              <li>Condiciones médicas preexistentes</li>
              <li>Medicación actual</li>
              <li>Grupo sanguíneo</li>
              <li>Contacto de emergencia</li>
              <li>Indicaciones especiales para atención</li>
          </div>
        </div>

        <div class="accordion-item">
          <div class="accordion-header">¿Necesito conexión a internet?</div>
          <div class="accordion-content">
            Sí; no obstante, si la cobertura es baja se muestra un resumen con los datos críticos.
          </div>
        </div>

        <div class="accordion-item">
          <div class="accordion-header">¿Funciona en cualquier país?</div>
          <div class="accordion-content">
            Mientras exista internet y un lector QR, tu información será accesible desde cualquier lugar del mundo.
          </div>
        </div>

        <h3 class="separador">SOBRE MI INFORMACIÓN</h3>
        <div class="accordion-item">
          <div class="accordion-header">¿Quién puede ver mis datos?</div>
          <div class="accordion-content">
            Solo quien escanee tu código QR. La información está cifrada y pensada para emergencias.
          </div>
        </div>

        <div class="accordion-item">
          <div class="accordion-header">¿Es seguro?</div>
          <div class="accordion-content">
            VITAQR utiliza protocolos de seguridad para proteger tu información; además, tú decides qué datos compartir y puedes actualizarlos en cualquier momento.
          </div>
        </div>

        <div class="accordion-item">
          <div class="accordion-header">¿Dónde lo llevo?</div>
          <div class="accordion-content">
            En pulsera, llavero, adhesivo para el móvil u otro accesorio visible para rescatistas.
          </div>
        </div>

        <div class="accordion-item">
          <div class="accordion-header">¿Puedo actualizar mis datos?</div>
          <div class="accordion-content">
            Sí, inicia sesión y edita o elimina la información cuando lo necesites.
          </div>
        </div>

      </div>
    </section>
  </main>

  <!-- ───────────────────────── ¿QUIENES SOMOS? -->
    <section id="quienes" style="display:none; text-align:center;">
      <h2 style="margin-bottom:30px;">¿Quiénes somos?</h2>

    <div style="max-width: 900px; margin: 0 auto;">
      <div style="margin-bottom: 50px;">
        <h3 style="color:#384c6b; font-size:24px;">VITAQR</h3>
        <p style="text-align:justify;">
          En VITAQR, nos apasiona transformar la manera en que compartimos información y experiencias a través de soluciones inteligentes y sostenibles. Somos un equipo comprometido con la innovación y el diseño de herramientas tecnológicas que permiten a las personas y empresas optimizar su presencia digital.
        </p>
      </div>

      <div>
        <h3 style="color:#384c6b; font-size:24px;">MISIÓN</h3>
        <p style="text-align:justify;">
          Nuestra misión es facilitar la conexión entre el mundo físico y digital mediante códigos QR personalizados, brindando acceso rápido, práctico y seguro a tus datos más importantes. Creemos que cada enlace cuenta, y por eso nos esforzamos en ofrecer un servicio único, confiable y adaptado a tus necesidades.
        </p>
      </div>
    </div>
    </section>

  <!-- =============  Modal del menú del usuario logueado  =============  -->
  <div id="usuarioMenu" class="modal" style="align-items: flex-start;">
    <div class="modal-content" style="margin-top: 100px; max-width: 300px;">
      <span class="close-btn" onclick="cerrarMenuUsuario()">✖</span>
      <h3>Opciones de Usuario</h3>
      <button onclick="abrirModalFoto()">🖼 Foto de perfil</button>
      <button onclick="abrirFormulario()">📝 Información</button>
      <button onclick="window.location.href='/generar_qr'">📱 Generar QR</button>
      <button onclick="cerrarSesion()">🚪 Cerrar Sesión</button>
    </div>
  </div>

  <div id="modalAdvertencia" style="display: none;">
    <div style="
      position: fixed;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      background-color: white;
      color: black;
      padding: 20px 30px;
      border: 2px solid #000000;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      z-index: 3000;
      text-align: center;
      font-family: Arial, sans-serif;
      min-width: 300px;
    ">
      <p id="mensajeAdvertencia" style="margin-bottom: 20px; font-weight: bold;">Mensaje de advertencia</p>
      <button onclick="cerrarAdvertencia()" style="
        padding: 10px 20px;
        background-color: #000000;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
      ">Aceptar</button>
    </div>
  </div>

  <!-- =============  MODAL REGISTRO SIMPLIFICADO  ============= -->
<div id="modalRegistro" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="cerrarModalRegistro()">✖</span>
    <h2>Crear cuenta</h2>

    <form id="formRegistroBasico">
      <div class="input-group"><input name="nombres"    type="text" placeholder="Nombre(s)" required></div>
      <div class="input-group"><input name="apellidos"  type="text" placeholder="Apellidos" required></div>
      <div class="input-group"><input name="dni"        type="number" placeholder="DNI" required></div>
      <div class="input-group"><input name="correo"     type="email" placeholder="Correo electrónico" required></div>
      <div class="input-group"><input name="contrasena" type="password" placeholder="Crear contraseña" required></div>
      <button type="submit">CONTINUAR</button>
    </form>
  </div>
</div>

  <!-- =============  MODAL FORMULARIO MÉDICO  ============= -->
  <div id="modalFormulario" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="cerrarModal()">✖</span>
      <h2>Formulario Médico Completo</h2>

      <p class="requerido">Completar los espacios obligatorios <span class="asterisco">*</span></p>
      
      <form id="formularioMedico">
        <div class="input-group required"><input type="text" name="nombres" placeholder="Nombres" pattern="[A-Za-zÁÉÍÓÚÑáéíóúñ\s]+" required title="Solo letras y espacios"/></div>
        <div class="input-group required"><input type="text" name="apellidos" placeholder="Apellidos" pattern="[A-Za-zÁÉÍÓÚÑáéíóúñ\s]+" required title="Solo letras y espacios" /></div>
        <div class="input-group required"><input type="number" name="dni" placeholder="Documento de Identidad (DNI)" required/></div>
        <div class="input-group required"><input type="number" name="edad" placeholder="Edad" required /></div>
        <div class="input-group"><select name="sexo">
          <option value="" disabled selected>Selecciona tu sexo</option>
          <option value="Masculino">Masculino</option>
          <option value="Femenino">Femenino</option>
          <!---<option value="Otro">Otro</option>-->
        </select></div>
        <div class="input-group"><select name="estado_civil">
          <option value="" disabled selected>Selecciona tu estado civil</option>
          <option value="soltero">Soltero(a)</option>
          <option value="casado">Casado(a)</option>
          <option value="viudo">Viudo(a)</option>
          <option value="divorciado">Divorciado(a)</option>
          <option value="conviviente">Conviviente civil</option>
        </select></div>
        <div class="input-group"><input type="text" name="religion" placeholder="Religión" pattern="[A-Za-zÁÉÍÓÚÑáéíóúñ\s]+" title="Solo letras y espacios"/></div>
        <div class="input-group required"><select name="sangre" required>
          <option value="" disabled selected>Selecciona tu tipo de sangre</option>
          <option value="A+">A+</option>
          <option value="A-">A-</option>
          <option value="B+">B+</option>
          <option value="B-">B-</option>
          <option value="AB+">AB+</option>
          <option value="AB-">AB-</option>
          <option value="O+">O+</option>
          <option value="O-">O-</option>
        </select></div>
        <div class="input-group"><input type="text" name="nacimiento" placeholder="Lugar de nacimiento" /></div>
        <div class="input-group required"><input type="text" name="nombre_contacto" placeholder="Nombre de contacto de emergencia" required /></div>
        <div class="input-group required"><input type="number" name="contactos" placeholder="Contacto de emergencia" required /></div>
         
        <!---INFORMACION MEDICA GENERAL-->
        <div class="input-group required"><input type="number" name="peso" placeholder="Peso en Kg" required /></div>
        <div class="input-group required"><input type="number" name="altura" placeholder="Altura en cm" required /></div>
        <div class="input-group required"><input type="text" name="alergias" placeholder="Alergias" pattern="[A-Za-zÁÉÍÓÚÑáéíóúñ\s]+" required title="Solo letras y espacios" /></div>
        <div class="input-group"><input type="text" name="condiciones" placeholder="Condiciones médicas" /></div>
        <div class="input-group"><input type="text" name="cirugias" placeholder="Cirugías previas" /></div>
        <div class="input-group"><input type="text" name="vacunas" placeholder="Vacunas importantes" /></div>
        <div class="input-group"><input type="text" name="seguro" placeholder="Seguro médico" /></div>
        <div class="input-group"><input type="text" name="clinica" placeholder="Clínica afiliada" /></div>
        
        <!---MEDICAMENTOS-->
        <div class="input-group"><input type="text" name="medicamentos_continuos" placeholder="Medicamento de uso continuos" /></div>
        <div class="input-group"><input type="text" name="medicamentos_emergencia" placeholder="Medicamento de uso ocasional / emergencia" /></div>
        
        <!---HISTORIAL FAMILIAR-->
        <div class="input-group"><input type="text" name="antecedentes_alergia" placeholder="Antecedentes alérgicas en familiares" /></div>
        <div class="input-group"><input type="text" name="enfermedades_hereditarias" placeholder="Enfermedades hereditarias" /></div>
        
        <!---ESTILO DE VIDA-->
        <div class="input-group"><input type="text" name="fuma" placeholder="Fuma" /></div>
        <div class="input-group"><input type="text" name="bebe" placeholder="Bebe alcohol" /></div>

        <button type="submit">Guardar</button>
      </form>
    </div>
  </div>

  <!-- =============  FOTO DE PERFIL  ============= -->
  <div id="modalFotoPerfil" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="cerrarModalFoto()">&times;</span>
      <h2>Subir Foto de Perfil</h2>
      <form id="formFotoPerfil" method="POST" action="/subir_foto" enctype="multipart/form-data">
        <input type="file" name="foto" accept="image/*" required />
        <button type="submit">Subir</button>
      </form>
    </div>
  </div>

  <!-- =============  MODAL QR  ============= -->
  <div id="modalQR" class="modal" onclick="cerrarAlClickFuera(event)">
    <div class="modal-content qr-modal-content">
      <span class="close close-qr" onclick="cerrarQR()">&times;</span>
      <h2>Escanea tu QR</h2>

      <div id="qrContainer" style="display:flex; justify-content:center; margin-top:20px;"></div>

      <button id="verInfoBtn" style="
        margin-top: 20px;
        padding: 10px 16px;
        background-color: #384c6b;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
      ">Ver información</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script>
  function toggleMenu() {
    const menu = document.getElementById("main-menu");
    menu.classList.toggle("show");
  }

  // Cargar estado de sesión
  window.addEventListener("DOMContentLoaded", () => {
    fetch('/usuario_actual')
      .then(r => r.json())
      .then(data => {
        const dni = data.dni;
        if (!dni) return;

        const userContainer = document.getElementById("user-container");
        const nombreUsuario = document.getElementById("usuario-btn");
        const dropdown = document.getElementById("usuario-dropdown");
        const loginBtn = document.querySelector("#loginForm button");

        if (data.nombre) {
          nombreUsuario.textContent = `👤 ${data.nombre}`;
          userContainer.style.display = "inline-block";

          if (loginBtn) {
            loginBtn.disabled = true;
            loginBtn.style.opacity = 0.6;
            loginBtn.style.cursor = "not-allowed";
            loginBtn.textContent = "Sesión activa";
          }

          nombreUsuario.onclick = (e) => {
            e.stopPropagation();
            dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
            if (dropdown.style.display === "block") {
              cargarInfoPlan();
            }
          };

          document.addEventListener("click", function(event) {
            if (!userContainer.contains(event.target)) {
              dropdown.style.display = "none";
            }
          });
        }

        // Validar botón Generar QR
        fetch('/usuario_actual')
          .then(r => r.json())
          .then(data => {
            const dni = data.dni;
            if (!dni) return;

            const userContainer = document.getElementById("user-container");
            const nombreUsuario = document.getElementById("usuario-btn");
            const dropdown = document.getElementById("usuario-dropdown");
            const loginBtn = document.querySelector("#loginForm button");

            if (data.nombre) {
              nombreUsuario.textContent = `👤 ${data.nombre}`;
              userContainer.style.display = "inline-block";

              if (loginBtn) {
                loginBtn.disabled = true;
                loginBtn.style.opacity = 0.6;
                loginBtn.style.cursor = "not-allowed";
                loginBtn.textContent = "Sesión activa";
              }

              nombreUsuario.onclick = (e) => {
                e.stopPropagation();
                dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
                if (dropdown.style.display === "block") {
                  cargarInfoPlan();
                }
              };

              document.addEventListener("click", function(event) {
                if (!userContainer.contains(event.target)) {
                  dropdown.style.display = "none";
                }
              });
            }

            // Nueva validación: formulario + plan activo
            Promise.all([
              fetch(`/verificar_formulario?dni=${dni}`).then(r => r.json()),
              fetch('/plan_usuario').then(r => r.json())
            ])
            .then(([formulario, planData]) => {
              const botonQR = [...document.querySelectorAll("button")]
                .find(btn => btn.textContent.includes("Generar QR"));

              const tieneFormulario = formulario.completado;
              const tienePlan = !!planData.plan;

              if (botonQR) {
                if (tieneFormulario && tienePlan) {
                  botonQR.disabled = false;
                  botonQR.style.opacity = 1;
                  botonQR.title = "";
                } else {
                  botonQR.disabled = true;
                  botonQR.style.opacity = 0.5;
                  botonQR.title = !tieneFormulario
                    ? "Debe llenar el formulario antes de generar su código QR."
                    : "Debe tener un plan activo para generar su código QR.";
                }
              }
            });
          });
      });

    validarBotonFormulario();
  });

    // AGREGAR FOTO DE PERFIL
  function abrirModalFoto() {
    document.getElementById('modalFotoPerfil').style.display = 'flex';
  }

  function cerrarModalFoto() {
    document.getElementById('modalFotoPerfil').style.display = 'none';
  }

  function cerrarSesion() {
    fetch('/cerrar_sesion').then(() => location.reload());
  }

  function abrirFormulario() {
    document.getElementById("modalFormulario").style.display = "flex";
    document.getElementById("usuario-dropdown").style.display = "none";
  }

  function cerrarModal() {
    document.getElementById("modalFormulario").style.display = "none";
    document.querySelector("#modalFormulario form").reset();
  }

  function mostrarAdvertencia(mensaje) {
    document.getElementById("mensajeAdvertencia").textContent = mensaje;
    document.getElementById("modalAdvertencia").style.display = "block";
  }

  function cerrarAdvertencia() {
    document.getElementById("modalAdvertencia").style.display = "none";
  }

  function abrirModalRegistro() {
    document.getElementById("modalRegistro").style.display = "flex";
  }

  function cerrarModalRegistro() {
    document.getElementById("modalRegistro").style.display = "none";
    document.getElementById("formRegistroBasico").reset();
  }

  function cerrarModalSesion() {
    document.getElementById("modalSesion").style.display = "none";
  }

  function cerrarAlClickFuera(event) {
    const modal = document.getElementById("modalQR");
    const content = document.querySelector("#modalQR .modal-content");
    if (event.target === modal || !content.contains(event.target)) {
      cerrarQR();
    }
  }

  function irAlCarrito() {
    fetch('/usuario_actual')
      .then(res => res.json())
      .then(data => {
        if (data.nombre) {
          window.location.href = "/carrito";
        } else {
          mostrarAdvertencia("Debes iniciar sesión para acceder al carrito.");
        }
      })
      .catch(() => {
        mostrarAdvertencia("Error al verificar la sesión.");
      });
  }

  document.getElementById("loginForm")?.addEventListener("submit", function(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);

    fetch("/login", {
      method: "POST",
      body: formData
    })
    .then(response => response.ok ? location.reload() : response.text().then(text => mostrarAdvertencia(text)))
    .catch(() => mostrarAdvertencia("Ocurrió un error al iniciar sesión."));
  });

  document.getElementById("formRegistroBasico").addEventListener("submit", function (e) {
    e.preventDefault();
    const formData = new FormData(this);

    fetch('/registrar_usuario', { method: 'POST', body: formData })
      .then(r => r.ok ? r.text() : Promise.reject("Error al registrar"))
      .then(msg => {
        const email = formData.get("correo");
        const password = formData.get("contrasena");

        return fetch("/login", {
          method: "POST",
          body: new URLSearchParams({ correo: email, contrasena: password })
        });
      })
      .then(loginResponse => {
        if (loginResponse.ok) {
          window.location.href = "/planes";
        } else {
          mostrarAdvertencia("Registro exitoso, pero no se pudo iniciar la sesión.");
        }
      })
      .catch(err => mostrarAdvertencia(err));
  });

  document.getElementById("formularioMedico").addEventListener("submit", function(e) {
    e.preventDefault();
    const formData = new FormData(this);

    fetch("/guardar_formulario", {
      method: "POST",
      body: formData
    })
    .then(r => r.text())
    .then(msg => {
      cerrarModal();
      mostrarAdvertencia(msg);
      
      validarBotonFormulario(); 
    })
    .catch(() => {
      cerrarModal();
      mostrarAdvertencia("Error al guardar los datos.");
    });
  });

  function cargarInfoPlan() {
    fetch('/plan_usuario')
      .then(res => res.json())
      .then(data => {
        const infoPlan = document.getElementById("info-plan");
        if (data.plan && infoPlan) {
          infoPlan.textContent = `Actualmente usted cuenta con el plan: ${data.plan}`;
        }
      })
      .catch(() => {
        console.warn("No se pudo obtener el plan del usuario.");
      });
  }

  function irAPlanes() {
    window.location.href = "/planes";
  }

  function generarQR() {
    fetch('/usuario_actual')
      .then(res => res.json())
      .then(data => {
        if (!data.dni) {
          alert("Debe iniciar sesión.");
          return;
        }

        const url = `${window.location.origin}/ver_formulario/${data.dni}`;
        const container = document.getElementById("qrContainer");
        container.innerHTML = "";
        new QRCode(container, {
          text: url,
          width: 200,
          height: 200
        });
        document.getElementById("modalQR").style.display = "flex";
      });
  }

  document.getElementById("verInfoBtn").addEventListener("click", function () {
    fetch("/usuario_actual")
      .then(res => res.json())
      .then(data => {
        if (data.dni) {
          window.location.href = `/ver_formulario/${data.dni}`;
        } else {
          alert("Debe iniciar sesión.");
        }
      });
  });

  function cerrarQR() {
    document.getElementById("modalQR").style.display = "none";
  }

  fetch('/plan_usuario')
    .then(res => res.json())
    .then(data => {
      if (data.plan) {
        const nombreUsuario = document.getElementById("usuario-btn");
        if (nombreUsuario) {
          nombreUsuario.textContent += ` - ${data.plan}`;
        }
      }
    });

  // FUNCIÓN DEL ACORDEÓN
  document.querySelectorAll('.accordion-header').forEach(header => {
    header.addEventListener('click', () => {
      const item = header.parentElement;
      item.classList.toggle('active');

      document.querySelectorAll('.accordion-item').forEach(otherItem => {
        if (otherItem !== item) {
          otherItem.classList.remove('active');
        }
      });
    });
  });

  // CONTROL DE SECCIONES + CIERRE DEL MENÚ EN CELULAR
  document.addEventListener("DOMContentLoaded", () => {
    const links = document.querySelectorAll("#main-menu .nav-link");
    const sections = {
      registro: document.getElementById("registro"),
      productos: document.getElementById("productos"),
      preguntas: document.getElementById("preguntas"),
      quienes: document.getElementById("quienes"),
    };

    links.forEach(link => {
      link.addEventListener("click", () => {
        links.forEach(l => l.classList.remove("active"));
        link.classList.add("active");

        const target = link.getAttribute("data-target");
        if (target && sections[target]) {
          Object.values(sections).forEach(sec => sec.style.display = "none");
          sections[target].style.display = "block";
        }

        const menu = document.getElementById("main-menu");
        if (window.innerWidth <= 768 && menu.classList.contains("show")) {
          menu.classList.remove("show");
        }
      });
    });
  });

  function validarBotonFormulario() {
    fetch('/usuario_actual')
      .then(resp => resp.json())
      .then(usuario => {
        if (!usuario.dni) return;

        const dni = usuario.dni;

        Promise.all([
          fetch(`/plan_usuario`).then(r => r.json()),
          fetch(`/verificar_formulario?dni=${dni}`).then(r => r.json())
        ])
        .then(([planData, formData]) => {
          const plan = planData.plan;
          const yaLlenado = formData.completado;

          // Deshabilitar botón "Información" si plan mensual y ya se llenó
          if (plan?.toLowerCase().trim() === 'mensual' && yaLlenado) {
            document.querySelectorAll("button").forEach(btn => {
              if (btn.textContent.includes("Información")) {
                btn.disabled = true;
                btn.style.opacity = 0.5;
                btn.title = "Ya has llenado tu información con el plan mensual.";
                btn.onclick = () => mostrarAdvertencia("Con el plan mensual, solo puedes llenar el formulario una vez.");
              }
            });
          }

          // Validar "Generar QR"
          const botonQR = [...document.querySelectorAll("button")]
            .find(btn => btn.textContent.includes("Generar QR"));
          if (botonQR) {
            if (plan && yaLlenado) {
              botonQR.disabled = false;
              botonQR.style.opacity = 1;
              botonQR.title = "";
            } else {
              botonQR.disabled = true;
              botonQR.style.opacity = 0.5;
              botonQR.title = !plan
                ? "Debe tener un plan activo para generar su código QR."
                : "Debe llenar el formulario antes de generar su código QR.";
            }
          }
        });
      })
      .catch(e => console.error("Error:", e));
  }

</script>


</body>
</html>